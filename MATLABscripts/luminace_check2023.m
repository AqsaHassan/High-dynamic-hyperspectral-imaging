% This code makes the luminosity image and checks  dynamic rage
load('mat_files/radiances_mean_Aqsa2023');
x = 390:830;
xq = [407.469357, 410.661992, 413.854626, 417.047260, 420.239895, 423.432529, 426.625163, 429.817798, 433.010432, 436.203066, 439.395701, 442.588335, 445.780969, 448.973603, 452.166238, 455.358872, 458.551506, 461.744141, 464.936775, 468.129409, 471.322044, 474.514678, 477.707312, 480.899947, 484.092581, 487.285215, 490.477849, 493.670484, 496.863118, 500.055752, 503.248387, 506.441021, 509.633655, 512.826290, 516.018924, 519.211558, 522.404193, 525.596827, 528.789461, 531.982095, 535.174730, 538.367364, 541.559998, 544.752633, 547.945267, 551.137901, 554.330536, 557.523170, 560.715804, 563.908439, 567.101073, 570.293707, 573.486341, 576.678976, 579.871610, 583.064244, 586.256879, 589.449513, 592.642147, 595.834782, 599.027416, 602.220050, 605.412685, 608.605319, 611.797953, 614.990587, 618.183222, 621.375856, 624.568490, 627.761125, 630.953759, 634.146393, 637.339028, 640.531662, 643.724296, 646.916931, 650.109565, 653.302199, 656.494833, 659.687468, 662.880102, 666.072736, 669.265371, 672.458005, 675.650639, 678.843274, 682.035908, 685.228542, 688.421177, 691.613811, 694.806445, 697.999079, 701.191714, 704.384348, 707.576982, 710.769617, 713.962251, 717.154885, 720.347520, 723.540154, 726.732788, 729.925423, 733.118057, 736.310691, 739.503325, 742.695960, 745.888594, 749.081228, 752.273863, 755.466497, 758.659131, 761.851766, 765.044400, 768.237034, 771.429669, 774.622303, 777.814937, 781.007571, 784.200206, 787.392840, 790.585474, 793.778109, 796.970743, 800.163377, 803.356012, 806.548646, 809.741280, 812.933915, 816.126549, 819.319183, 822.511818, 825.704452, 828.897086, 832.089720, 835.282355, 838.474989, 841.667623, 844.860258, 848.052892, 851.245526, 854.438161, 857.630795, 860.823429, 864.016064, 867.208698, 870.401332, 873.593966, 876.786601, 879.979235, 883.171869, 886.364504, 889.557138, 892.749772, 895.942407, 899.135041, 902.327675, 905.520310, 908.712944, 911.905578, 915.098212, 918.290847, 921.483481, 924.676115, 927.868750, 931.061384, 934.254018, 937.446653, 940.639287, 943.831921, 947.024556, 950.217190, 953.409824, 956.602458, 959.795093, 962.987727, 966.180361, 969.372996, 972.565630, 975.758264, 978.950899, 982.143533, 985.336167, 988.528802, 991.721436, 994.914070, 998.106704];
v_lambda = [4.15E-04,5.03E-04,6.08E-04,7.34E-04,8.84E-04,1.06E-03,1.27E-03,1.50E-03,1.78E-03,2.10E-03,2.45E-03,2.85E-03,3.30E-03,3.80E-03,4.35E-03,4.97E-03,5.66E-03,6.42E-03,7.25E-03,8.14E-03,9.08E-03,1.01E-02,1.11E-02,1.21E-02,1.32E-02,1.43E-02,1.55E-02,1.66E-02,1.79E-02,1.91E-02,2.03E-02,2.14E-02,2.26E-02,2.37E-02,2.49E-02,2.61E-02,2.74E-02,2.87E-02,3.02E-02,3.17E-02,3.32E-02,3.48E-02,3.64E-02,3.81E-02,3.98E-02,4.16E-02,4.34E-02,4.52E-02,4.70E-02,4.87E-02,5.03E-02,5.19E-02,5.33E-02,5.47E-02,5.61E-02,5.74E-02,5.89E-02,6.03E-02,6.18E-02,6.33E-02,6.47E-02,6.61E-02,6.76E-02,6.90E-02,7.06E-02,7.24E-02,7.44E-02,7.66E-02,7.91E-02,8.20E-02,8.51E-02,8.87E-02,9.27E-02,9.69E-02,1.01E-01,1.06E-01,1.11E-01,1.16E-01,1.20E-01,1.25E-01,1.30E-01,1.35E-01,1.39E-01,1.44E-01,1.49E-01,1.54E-01,1.58E-01,1.63E-01,1.68E-01,1.74E-01,1.79E-01,1.84E-01,1.90E-01,1.95E-01,2.01E-01,2.06E-01,2.12E-01,2.18E-01,2.24E-01,2.31E-01,2.38E-01,2.46E-01,2.55E-01,2.64E-01,2.74E-01,2.85E-01,2.96E-01,3.09E-01,3.21E-01,3.34E-01,3.48E-01,3.63E-01,3.78E-01,3.94E-01,4.11E-01,4.28E-01,4.45E-01,4.64E-01,4.82E-01,5.01E-01,5.20E-01,5.40E-01,5.60E-01,5.80E-01,6.00E-01,6.21E-01,6.41E-01,6.61E-01,6.81E-01,7.00E-01,7.18E-01,7.35E-01,7.51E-01,7.66E-01,7.81E-01,7.95E-01,8.08E-01,8.21E-01,8.34E-01,8.46E-01,8.58E-01,8.68E-01,8.78E-01,8.88E-01,8.98E-01,9.07E-01,9.17E-01,9.27E-01,9.37E-01,9.46E-01,9.54E-01,9.62E-01,9.68E-01,9.74E-01,9.78E-01,9.81E-01,9.84E-01,9.85E-01,9.86E-01,9.88E-01,9.89E-01,9.91E-01,9.93E-01,9.96E-01,9.98E-01,9.99E-01,1.00E+00,1.00E+00,9.99E-01,9.98E-01,9.97E-01,9.96E-01,9.95E-01,9.94E-01,9.92E-01,9.90E-01,9.88E-01,9.85E-01,9.82E-01,9.78E-01,9.73E-01,9.68E-01,9.63E-01,9.57E-01,9.50E-01,9.42E-01,9.34E-01,9.24E-01,9.15E-01,9.05E-01,8.96E-01,8.88E-01,8.81E-01,8.74E-01,8.66E-01,8.59E-01,8.50E-01,8.42E-01,8.32E-01,8.22E-01,8.12E-01,8.01E-01,7.90E-01,7.78E-01,7.66E-01,7.54E-01,7.42E-01,7.30E-01,7.17E-01,7.05E-01,6.92E-01,6.79E-01,6.66E-01,6.53E-01,6.40E-01,6.27E-01,6.14E-01,6.00E-01,5.86E-01,5.72E-01,5.58E-01,5.45E-01,5.31E-01,5.17E-01,5.03E-01,4.90E-01,4.76E-01,4.62E-01,4.49E-01,4.36E-01,4.23E-01,4.10E-01,3.98E-01,3.86E-01,3.73E-01,3.61E-01,3.48E-01,3.36E-01,3.23E-01,3.10E-01,2.98E-01,2.86E-01,2.74E-01,2.63E-01,2.52E-01,2.42E-01,2.31E-01,2.22E-01,2.12E-01,2.03E-01,1.94E-01,1.86E-01,1.78E-01,1.70E-01,1.62E-01,1.55E-01,1.47E-01,1.40E-01,1.33E-01,1.26E-01,1.19E-01,1.13E-01,1.07E-01,1.01E-01,9.52E-02,8.98E-02,8.47E-02,7.98E-02,7.52E-02,7.09E-02,6.67E-02,6.28E-02,5.90E-02,5.55E-02,5.22E-02,4.90E-02,4.60E-02,4.32E-02,4.05E-02,3.80E-02,3.56E-02,3.33E-02,3.12E-02,2.92E-02,2.73E-02,2.55E-02,2.39E-02,2.23E-02,2.08E-02,1.94E-02,1.81E-02,1.68E-02,1.57E-02,1.46E-02,1.36E-02,1.26E-02,1.17E-02,1.09E-02,1.01E-02,9.33E-03,8.66E-03,8.05E-03,7.48E-03,6.96E-03,6.48E-03,6.03E-03,5.61E-03,5.22E-03,4.85E-03,4.51E-03,4.20E-03,3.90E-03,3.63E-03,3.37E-03,3.13E-03,2.91E-03,2.70E-03,2.51E-03,2.32E-03,2.15E-03,2.00E-03,1.85E-03,1.71E-03,1.59E-03,1.47E-03,1.37E-03,1.27E-03,1.18E-03,1.09E-03,1.02E-03,9.45E-04,8.78E-04,8.15E-04,7.57E-04,7.03E-04,6.54E-04,6.08E-04,5.65E-04,5.26E-04,4.90E-04,4.56E-04,4.24E-04,3.95E-04,3.67E-04,3.42E-04,3.18E-04,2.96E-04,2.75E-04,2.56E-04,2.38E-04,2.22E-04,2.07E-04,1.93E-04,1.80E-04,1.68E-04,1.57E-04,1.46E-04,1.36E-04,1.27E-04,1.18E-04,1.10E-04,1.03E-04,9.61E-05,8.97E-05,8.38E-05,7.83E-05,7.31E-05,6.83E-05,6.39E-05,5.97E-05,5.58E-05,5.21E-05,4.87E-05,4.55E-05,4.26E-05,3.98E-05,3.73E-05,3.49E-05,3.26E-05,3.06E-05,2.86E-05,2.68E-05,2.50E-05,2.34E-05,2.19E-05,2.05E-05,1.92E-05,1.80E-05,1.69E-05,1.59E-05,1.49E-05,1.40E-05,1.31E-05,1.23E-05,1.15E-05,1.08E-05,1.01E-05,9.51E-06,8.93E-06,8.38E-06,7.86E-06,7.38E-06,6.93E-06,6.51E-06,6.11E-06,5.74E-06,5.39E-06,5.07E-06,4.76E-06,4.48E-06,4.21E-06,3.96E-06,3.73E-06,3.51E-06,3.30E-06,3.11E-06,2.92E-06,2.75E-06,2.58E-06,2.43E-06,2.29E-06,2.15E-06,2.03E-06,1.91E-06,1.80E-06,1.69E-06,1.60E-06,1.50E-06,1.42E-06,1.34E-06,1.26E-06,1.19E-06,1.12E-06,1.06E-06,9.99E-07,9.42E-07,8.89E-07,8.39E-07,7.91E-07,7.47E-07,7.05E-07];

interpolated_eff = interp1(x,v_lambda, xq)';


luminosity_img = zeros(3976, 1800);

for r = 1 : size(radiances_mean, 1)
    for c = 1 : size(radiances_mean, 2)
        luminosity_img(r, c) = sum(squeeze(radiances_mean(r, c, 1:133)) .* interpolated_eff(1:133));
    end
end

max_lum = 683.*max(luminosity_img(:));
min_lum = 683.*min(luminosity_img(:));






dynamic_range = max_lum/min_lum;
luminosity_img = luminosity_img*683; 


% plotting
% alpha = ones(size(luminosity_img)) .* 0.5;
% imshow(final_img);
% hold on
overlay_img = imshow(luminosity_img);
% caxis auto  
clim([min_lum max_lum]);
colormap( overlay_img.Parent, jet );
colorbar( overlay_img.Parent );
% set( overlay_img, 'AlphaData', alpha );
set( overlay_img);
