%load ('EQ_nonEQ_data.mat');



EQ_filter = [0.072,0.037,0.008,0.009,0.014,0.012,0.006,0.005,0.006,0.009,0.008,0.006,0.005,0.006,0.005,0.005,0.002,0.006,0.003,0.002,0.003,0.002,0.003,0.005,0.003,0.003,0.002,0.003,0.005,0.003,0.003,0.003,0.002,0.003,0.003,0.003,0.002,0.002,0.003,0.003,0.005,0.003,0.002,0.002,0.002,0.003,0.003,0.003,0.003,0.003,0.005,0.003,0.003,0.003,0.002,0.003,0.003,0.002,0.003,0.003,0.003,0.003,0.005,0.003,0.005,0.003,0.003,0.005,0.006,0.006,0.006,0.005,0.005,0.006,0.006,0.009,0.009,0.011,0.008,0.008,0.009,0.012,0.015,0.017,0.023,0.031,0.038,0.047,0.066,0.092,0.117,0.16,0.211,0.266,0.333,0.407,0.496,0.595,0.719,0.876,1.067,1.309,1.622,2.028,2.539,3.198,4.05,5.142,6.462,8.023,9.972,12.372,15.018,17.776,20.564,22.925,24.738,25.94,26.517,26.701,26.697,26.628,26.636,26.762,27.083,27.576,28.261,29.091,30.023,31.12,32.278,33.455,34.538,35.614,36.569,37.318,37.825,38.152,38.318,38.354,38.287,38.197,38.129,38.089,38.152,38.327,38.631,39.111,39.754,40.593,41.513,42.638,44.145,45.813,47.673,49.786,52.01,54.349,56.699,59.033,61.299,63.503,65.506,67.119,68.347,69.208,69.534,69.449,68.918,68.076,66.98,65.689,64.265,62.81,61.383,60.1,58.823,57.635,56.602,55.777,55.043,54.468,54.088,53.792,53.699,53.745,53.97,54.364,54.886,55.562,56.396,57.405,58.519,59.773,61.182,62.753,64.375,66.055,67.83,69.717,71.658,73.686,75.742,77.812,79.842,81.799,83.652,85.368,87.016,88.493,89.969,91.27,92.447,93.451,94.325,95.024,95.596,96.075,96.442,96.667,96.825,96.902,96.93,96.907,96.838,96.753,96.651,96.518,96.416,96.321,96.22,96.124,96.045,95.982,95.937,95.906,95.891,95.903,95.92,95.956,95.985,96.046,96.103,96.164,96.242,96.318,96.396,96.466,96.527,96.603,96.663,96.716,96.776,96.805,96.843,96.867,96.873,96.896,96.895,96.893,96.87,96.858,96.834,96.814,96.779,96.742,96.715,96.683,96.623,96.602,96.559,96.523,96.494,96.458,96.429,96.404,96.371,96.356,96.338,96.31,96.298,96.292,96.289,96.291,96.281,96.283,96.281,96.286,96.298,96.315,96.313,96.324,96.339,96.361,96.362,96.378,96.402,96.414,96.439,96.46,96.484,96.501,96.527,96.556,96.585,96.605,96.622,96.649,96.684,96.706,96.736,96.783,96.806,96.846,96.884,96.924,96.957,96.985,97.035,97.07,97.112,97.145,97.185,97.224,97.255,97.278,97.322,97.343,97.371,97.375,97.389,97.389,97.382,97.365,97.348,97.322,97.266,97.212,97.142,97.054,96.951,96.828,96.681,96.524,96.352,96.156,95.927,95.679,95.416,95.135,94.81,94.473,94.101,93.695,93.269,92.85,92.415,91.925,91.399,90.869,90.305,89.688,89.096,88.461,87.79,87.103,86.392,85.655,84.927,84.189,83.426,82.655,81.877,81.039,80.232,79.437,78.638,77.8,76.971,76.141,75.314,74.492,73.616,72.751,71.91,71.075,70.247,69.385,68.542,67.696,66.872,66.069,65.28,64.49,63.722,62.949,62.17,61.406,60.654,59.926,59.207,58.496,57.787,57.129,56.479,55.809,55.142,54.507,53.885,53.282,52.702,52.116,51.53,50.974,50.427,49.879,49.359,48.865,48.364,47.879,47.408,46.93,46.481,46.062,45.647,45.239,44.852,44.461,44.084,43.713,43.358,42.986,42.635,42.303,41.986,41.658,41.347,41.048,40.762,40.482,40.208,39.946,39.699,39.438,39.209,38.963,38.733,38.504,38.293,38.091,37.892,37.717,37.541,37.363,37.193,37.033,36.876,36.723,36.581,36.44,36.301,36.172,36.044,35.925,35.818,35.716,35.619,35.526,35.437,35.353,35.281,35.208,35.146,35.086,35.03,34.979,34.935,34.889,34.851,34.822,34.795,34.772,34.75,34.737,34.731,34.729,34.731,34.735,34.744,34.756,34.775,34.801,34.824,34.856,34.895,34.937,34.981,35.028,35.078,35.135,35.201,35.265,35.336,35.416,35.49,35.576,35.661,35.753,35.854,35.957,36.064,36.172,36.287,36.403,36.523,36.658,36.787,36.919,37.054,37.196,37.337,37.488,37.639,37.794,37.961,38.136,38.306,38.483,38.66,38.85,39.041,39.24,39.439,39.645,39.854,40.068,40.283,40.5,40.727,40.961,41.202,41.454,41.693,41.937,42.18,42.436,42.7,42.97,43.245,43.524,43.805,44.081,44.376,44.673,44.966,45.276,45.589,45.905,46.213,46.53,46.857,47.189,47.525,47.865,48.199,48.54,48.882,49.231,49.588,49.934,50.31,50.702,51.083,51.466,51.854,52.246,52.643,53.05,53.448,53.838,54.253,54.669,55.074,55.499,55.92,56.357,56.792,57.231,57.672,58.099,58.533,58.983,59.431,59.872,60.341,60.794,61.243,61.7,62.169,62.624,63.098,63.576,64.063,64.543,64.995,65.462,65.932,66.402,66.887,67.366,67.828,68.288,68.762,69.228,69.688,70.152,70.633,71.111,71.584,72.05,72.514,72.995,73.47,73.941,74.402,74.855,75.31,75.766,76.224,76.678,77.147,77.614,78.05,78.481,78.915,79.337,79.77,80.205,80.624,81.053,81.451,81.873,82.277,82.677,83.069,83.466,83.855,84.244,84.631,85.004,85.367,85.733,86.081,86.436,86.781,87.12,87.444,87.767,88.089,88.393,88.702,89.009,89.308,89.601,89.899,90.19,90.468,90.746,91.01,91.258,91.513,91.769,92.018,92.242,92.476,92.711,92.935,93.153,93.353,93.556,93.764,93.962,94.147,94.33,94.507,94.666,94.841,94.998,95.158,95.309,95.445,95.595,95.743,95.872,95.995,96.118,96.242,96.358,96.458,96.561,96.669,96.768,96.849,96.938,97.026,97.113,97.194,97.263,97.337,97.417,97.472,97.536,97.607,97.665,97.708,97.76,97.813,97.856,97.91,97.949,97.984,98.035,98.065,98.087,98.117,98.145,98.167,98.213,98.228,98.241,98.262,98.3,98.323,98.328,98.335,98.347,98.367,98.372,98.367,98.383,98.399,98.39,98.405,98.424,98.402,98.416,98.407,98.41,98.415,98.392,98.393,98.415,98.39,98.395,98.392,98.384,98.392,98.364,98.378,98.36,98.34,98.346,98.328,98.334,98.318,98.323,98.311,98.311,98.3,98.288,98.26,98.262,98.247,98.242,98.221,98.239,98.212,98.213,98.201,98.199,98.189,98.181,98.163,98.155,98.154,98.143,98.132,98.119,98.122,98.111,98.1,98.091,98.085,98.08,98.062,98.058,98.048,98.038,98.027,98.035,98.019,97.993,97.984,97.984,97.981,97.969,97.955,97.958,97.932,97.911,97.903,97.92,97.92,97.914,97.894,97.87,97.87,97.884,97.885,97.861,97.829,97.81,97.8,97.798,97.804,97.815,97.813,97.797,97.789,97.769,97.777,97.758,97.726,97.705,97.694,97.668,97.664,97.656,97.639,97.62,97.624,97.624,97.607,97.603,97.6,97.58,97.572,97.562,97.537,97.53,97.517,97.502,97.485,97.479,97.464,97.455,97.444,97.435,97.411,97.394,97.385,97.363,97.343,97.333,97.324,97.304,97.292,97.272,97.26,97.243,97.252,97.232,97.203,97.185,97.145,97.133,97.142,97.136,97.105,97.061,97.061,97.064,97.054,97.029,96.967,96.977,96.988,96.977,96.916,96.863,96.899,96.878,96.806,96.799,96.835,96.785,96.721,96.729,96.765,96.689,96.664,96.687,96.62,96.559,96.619,96.535,96.501,96.533,96.437,96.483,96.457];
x = 190:1100;
xq = [407.469357, 410.661992, 413.854626, 417.047260, 420.239895, 423.432529, 426.625163, 429.817798, 433.010432, 436.203066, 439.395701, 442.588335, 445.780969, 448.973603, 452.166238, 455.358872, 458.551506, 461.744141, 464.936775, 468.129409, 471.322044, 474.514678, 477.707312, 480.899947, 484.092581, 487.285215, 490.477849, 493.670484, 496.863118, 500.055752, 503.248387, 506.441021, 509.633655, 512.826290, 516.018924, 519.211558, 522.404193, 525.596827, 528.789461, 531.982095, 535.174730, 538.367364, 541.559998, 544.752633, 547.945267, 551.137901, 554.330536, 557.523170, 560.715804, 563.908439, 567.101073, 570.293707, 573.486341, 576.678976, 579.871610, 583.064244, 586.256879, 589.449513, 592.642147, 595.834782, 599.027416, 602.220050, 605.412685, 608.605319, 611.797953, 614.990587, 618.183222, 621.375856, 624.568490, 627.761125, 630.953759, 634.146393, 637.339028, 640.531662, 643.724296, 646.916931, 650.109565, 653.302199, 656.494833, 659.687468, 662.880102, 666.072736, 669.265371, 672.458005, 675.650639, 678.843274, 682.035908, 685.228542, 688.421177, 691.613811, 694.806445, 697.999079, 701.191714, 704.384348, 707.576982, 710.769617, 713.962251, 717.154885, 720.347520, 723.540154, 726.732788, 729.925423, 733.118057, 736.310691, 739.503325, 742.695960, 745.888594, 749.081228, 752.273863, 755.466497, 758.659131, 761.851766, 765.044400, 768.237034, 771.429669, 774.622303, 777.814937, 781.007571, 784.200206, 787.392840, 790.585474, 793.778109, 796.970743, 800.163377, 803.356012, 806.548646, 809.741280, 812.933915, 816.126549, 819.319183, 822.511818, 825.704452, 828.897086, 832.089720, 835.282355, 838.474989, 841.667623, 844.860258, 848.052892, 851.245526, 854.438161, 857.630795, 860.823429, 864.016064, 867.208698, 870.401332, 873.593966, 876.786601, 879.979235, 883.171869, 886.364504, 889.557138, 892.749772, 895.942407, 899.135041, 902.327675, 905.520310, 908.712944, 911.905578, 915.098212, 918.290847, 921.483481, 924.676115, 927.868750, 931.061384, 934.254018, 937.446653, 940.639287, 943.831921, 947.024556, 950.217190, 953.409824, 956.602458, 959.795093, 962.987727, 966.180361, 969.372996, 972.565630, 975.758264, 978.950899, 982.143533, 985.336167, 988.528802, 991.721436, 994.914070, 998.106704];

interpolated_trans = interp1(x, EQ_filter/100, xq)';

%we change the dimension arrangement such that 186 is in first of 3D without_ND 
permuted_nophyEQ_radiances_mean = permute(nophyEQ_radiances_mean,[3,1,2]);
%then this permuted 3D without_ND is converted to 2D 
reshape_per = reshape(permuted_nophyEQ_radiances_mean, 186, 731*900);

%multiplied with tranmittance values
applied_mask = interpolated_trans.*reshape_per;

%Reshape it back to the 3D such that still 186 wavelengths is in frist.
mask = reshape(applied_mask, 186, 731, 900);

%Now we shifted the wavelengths to the last dimension as originally it was.
cal_phyEQ_radiances_mean = permute(mask, [2, 3, 1]);

phy_EQ_1m_radiances_overallmean = mean(phy_EQ_1m_radiances_mean(:), 'omitnan')
cal_phyEQ_radiances_overallmean = mean(cal_phyEQ_radiances_mean(:), 'omitnan')

%red calculated
plot(xq, squeeze(mean(mean(cal_phyEQ_radiances_mean, 1, 'omitnan'), 'omitnan')),'r');
hold on;
%green ground truth
% red and green should be equal

plot(xq, squeeze(mean(mean(phy_EQ_1m_radiances_mean, 1, 'omitnan'), 'omitnan')),'g');
plot(xq, squeeze(mean(mean(phy_EQ_1mEQ_radiances_mean, 1, 'omitnan'), 'omitnan')),'blue');
plot(xq, squeeze(mean(mean(nophyEQ_radiances_mean, 1, 'omitnan'), 'omitnan')),'black');
legend('cal phyEQ radiancesmean','phy EQ 1m radiances mean', 'phy EQ 1mEQ radiances mean', 'nophyEQ_radiances_mean');

figure;
plot(xq, interpolated_trans,'black');