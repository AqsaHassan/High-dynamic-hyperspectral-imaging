% checking radinces from camera
clear all;
close all;
pathCB = 'D:\aqsa_ali_internship\cosi-internship\calibration\digital_numbers\';

headN = 'tile_VNIR_1800_SN00841_37059us_2022-07-21T164340_raw';
hcube = hypercube([pathCB headN]);
CUBE = hcube.DataCube(:,:,:);
digital_number = CUBE;

pathCB = 'D:\aqsa_ali_internship\cosi-internship\calibration\radiances\';

headN = 'tile_VNIR_1800_SN00841_37059us_2022-07-21T164340_raw_rad_float32';
hcube = hypercube([pathCB headN]);
CUBE = hcube.DataCube(:,:,:);
radiance = CUBE;

clear CUBE;


n_rows = size(digital_number, 1);
n_cols = size(digital_number, 2);
n_bands=size(digital_number,3);

%data from spectroradiometer
%range 380 to 780nm with 1nm step size
cs2000_spec=[2.88E-04	3.31E-04	3.52E-04	3.82E-04	4.48E-04	5.26E-04	5.55E-04	6.36E-04	7.20E-04	8.04E-04	9.06E-04	9.70E-04	1.08E-03	1.17E-03	1.27E-03	1.42E-03	1.51E-03	1.60E-03	1.74E-03	1.86E-03	1.95E-03	2.09E-03	2.26E-03	2.35E-03	2.49E-03	2.63E-03	2.76E-03	2.88E-03	3.03E-03	3.14E-03	3.30E-03	3.41E-03	3.51E-03	3.62E-03	3.76E-03	3.84E-03	3.96E-03	4.06E-03	4.16E-03	4.26E-03	4.37E-03	4.47E-03	4.55E-03	4.62E-03	4.72E-03	4.83E-03	4.91E-03	4.98E-03	5.04E-03	5.15E-03	5.25E-03	5.31E-03	5.36E-03	5.42E-03	5.47E-03	5.55E-03	5.62E-03	5.66E-03	5.75E-03	5.85E-03	5.90E-03	6.01E-03	6.10E-03	6.22E-03	6.28E-03	6.41E-03	6.50E-03	6.61E-03	6.69E-03	6.80E-03	6.91E-03	7.04E-03	7.12E-03	7.25E-03	7.34E-03	7.44E-03	7.53E-03	7.65E-03	7.75E-03	7.84E-03	7.94E-03	8.05E-03	8.15E-03	8.23E-03	8.32E-03	8.43E-03	8.52E-03	8.58E-03	8.66E-03	8.76E-03	8.81E-03	8.92E-03	9.01E-03	9.07E-03	9.13E-03	9.19E-03	9.27E-03	9.35E-03	9.44E-03	9.51E-03	9.58E-03	9.64E-03	9.71E-03	9.80E-03	9.89E-03	9.97E-03	1.01E-02	1.02E-02	1.03E-02	1.04E-02	1.05E-02	1.07E-02	1.08E-02	1.10E-02	1.11E-02	1.13E-02	1.14E-02	1.16E-02	1.18E-02	1.20E-02	1.21E-02	1.23E-02	1.25E-02	1.27E-02	1.28E-02	1.30E-02	1.32E-02	1.34E-02	1.35E-02	1.37E-02	1.39E-02	1.41E-02	1.42E-02	1.44E-02	1.46E-02	1.47E-02	1.49E-02	1.50E-02	1.52E-02	1.53E-02	1.55E-02	1.57E-02	1.58E-02	1.60E-02	1.61E-02	1.63E-02	1.64E-02	1.66E-02	1.68E-02	1.69E-02	1.71E-02	1.72E-02	1.74E-02	1.76E-02	1.77E-02	1.79E-02	1.81E-02	1.82E-02	1.83E-02	1.84E-02	1.85E-02	1.86E-02	1.87E-02	1.89E-02	1.90E-02	1.91E-02	1.92E-02	1.94E-02	1.95E-02	1.97E-02	1.98E-02	2.00E-02	2.02E-02	2.04E-02	2.06E-02	2.08E-02	2.09E-02	2.12E-02	2.14E-02	2.16E-02	2.17E-02	2.19E-02	2.21E-02	2.23E-02	2.25E-02	2.27E-02	2.29E-02	2.31E-02	2.33E-02	2.35E-02	2.36E-02	2.39E-02	2.41E-02	2.43E-02	2.45E-02	2.47E-02	2.49E-02	2.51E-02	2.53E-02	2.55E-02	2.57E-02	2.59E-02	2.61E-02	2.64E-02	2.66E-02	2.67E-02	2.69E-02	2.71E-02	2.73E-02	2.75E-02	2.77E-02	2.79E-02	2.81E-02	2.84E-02	2.86E-02	2.88E-02	2.90E-02	2.91E-02	2.93E-02	2.95E-02	2.97E-02	2.99E-02	3.01E-02	3.02E-02	3.04E-02	3.06E-02	3.07E-02	3.09E-02	3.11E-02	3.12E-02	3.14E-02	3.16E-02	3.17E-02	3.19E-02	3.20E-02	3.22E-02	3.23E-02	3.25E-02	3.26E-02	3.27E-02	3.28E-02	3.30E-02	3.31E-02	3.32E-02	3.33E-02	3.34E-02	3.35E-02	3.36E-02	3.37E-02	3.38E-02	3.39E-02	3.40E-02	3.41E-02	3.41E-02	3.42E-02	3.42E-02	3.43E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.45E-02	3.45E-02	3.45E-02	3.45E-02	3.45E-02	3.44E-02	3.44E-02	3.43E-02	3.43E-02	3.42E-02	3.42E-02	3.41E-02	3.40E-02	3.39E-02	3.38E-02	3.37E-02	3.35E-02	3.34E-02	3.33E-02	3.32E-02	3.29E-02	3.29E-02	3.27E-02	3.25E-02	3.23E-02	3.22E-02	3.19E-02	3.17E-02	3.16E-02	3.13E-02	3.12E-02	3.09E-02	3.06E-02	3.04E-02	3.02E-02	3.00E-02	2.98E-02	2.95E-02	2.93E-02	2.89E-02	2.87E-02	2.84E-02	2.81E-02	2.78E-02	2.76E-02	2.73E-02	2.71E-02	2.68E-02	2.65E-02	2.63E-02	2.60E-02	2.57E-02	2.54E-02	2.51E-02	2.48E-02	2.46E-02	2.42E-02	2.40E-02	2.37E-02	2.35E-02	2.31E-02	2.28E-02	2.26E-02	2.24E-02	2.21E-02	2.17E-02	2.16E-02	2.12E-02	2.09E-02	2.06E-02	2.04E-02	2.00E-02	1.98E-02	1.96E-02	1.93E-02	1.91E-02	1.88E-02	1.85E-02	1.82E-02	1.80E-02	1.78E-02	1.75E-02	1.73E-02	1.71E-02	1.68E-02	1.66E-02	1.64E-02	1.63E-02	1.61E-02	1.59E-02	1.56E-02	1.55E-02	1.54E-02	1.53E-02	1.51E-02	1.50E-02	1.48E-02	1.47E-02	1.45E-02	1.45E-02	1.44E-02	1.43E-02	1.42E-02	1.41E-02	1.41E-02	1.41E-02	1.39E-02	1.39E-02	1.38E-02	1.37E-02	1.37E-02	1.36E-02	1.36E-02	1.37E-02	1.36E-02	1.35E-02	1.35E-02	1.34E-02	1.34E-02	1.33E-02	1.33E-02	1.34E-02	1.34E-02	1.34E-02	1.33E-02	1.33E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.31E-02	1.32E-02	1.31E-02	1.31E-02	1.31E-02	1.31E-02];

%defining an img for creating mask using a random wavelength
img=digital_number(:,:,80);

% creating a circular mask from downloaded matlab function at with center
% at 117,860(note that this function takes the argument reversed) with a
% radius of 53 pixels
% ref: https://se.mathworks.com/matlabcentral/fileexchange/47905-createcirclesmask-m
mask=createCirclesMask(img,[860,117], [53]);

%extending mask from 2D to 3D
mask=repmat(mask, [1,1, n_bands]);

%applying mask on radiance
rad_masked=mask.*radiance;

% changing the dimension so that wavelength comes first. The will help to
% flatten the radiance that will be helpful for taking mean
rad_masked = permute(rad_masked,[3,1,2]);

%1d masked radiances with dimension of (nband x nrow x ncol,1)
rad_masked_flat=rad_masked(:);

%making it 2D using reshape with dimension of (nband, nrow x ncol) for
%taking mean
rad_masked_flat=reshape(rad_masked_flat,[n_bands, n_rows*n_cols]);

%1d mask with dimension of (nband x nrow x ncol,1)
mask_flat=mask(:);

%making mask 2D using reshape with dimension of (nband, nrow x ncol) for
%getting valid values for mean
mask_flat=reshape(mask_flat,[n_bands, n_rows*n_cols]);
 
%the sum of valid pixel location in the mask
n_valid_entries = sum(mask_flat,2);

%taking mean radiance
mean_rad = sum(rad_masked_flat,2)./n_valid_entries;

%Vector x contains the wavelength values from CS2000, and v contains the
%corresponding radiances, v(x). Vector xq contains the wavelengths at which
%I need the radiance to be interpolated

x = 380:780;
v = [2.88E-04	3.31E-04	3.52E-04	3.82E-04	4.48E-04	5.26E-04	5.55E-04	6.36E-04	7.20E-04	8.04E-04	9.06E-04	9.70E-04	1.08E-03	1.17E-03	1.27E-03	1.42E-03	1.51E-03	1.60E-03	1.74E-03	1.86E-03	1.95E-03	2.09E-03	2.26E-03	2.35E-03	2.49E-03	2.63E-03	2.76E-03	2.88E-03	3.03E-03	3.14E-03	3.30E-03	3.41E-03	3.51E-03	3.62E-03	3.76E-03	3.84E-03	3.96E-03	4.06E-03	4.16E-03	4.26E-03	4.37E-03	4.47E-03	4.55E-03	4.62E-03	4.72E-03	4.83E-03	4.91E-03	4.98E-03	5.04E-03	5.15E-03	5.25E-03	5.31E-03	5.36E-03	5.42E-03	5.47E-03	5.55E-03	5.62E-03	5.66E-03	5.75E-03	5.85E-03	5.90E-03	6.01E-03	6.10E-03	6.22E-03	6.28E-03	6.41E-03	6.50E-03	6.61E-03	6.69E-03	6.80E-03	6.91E-03	7.04E-03	7.12E-03	7.25E-03	7.34E-03	7.44E-03	7.53E-03	7.65E-03	7.75E-03	7.84E-03	7.94E-03	8.05E-03	8.15E-03	8.23E-03	8.32E-03	8.43E-03	8.52E-03	8.58E-03	8.66E-03	8.76E-03	8.81E-03	8.92E-03	9.01E-03	9.07E-03	9.13E-03	9.19E-03	9.27E-03	9.35E-03	9.44E-03	9.51E-03	9.58E-03	9.64E-03	9.71E-03	9.80E-03	9.89E-03	9.97E-03	1.01E-02	1.02E-02	1.03E-02	1.04E-02	1.05E-02	1.07E-02	1.08E-02	1.10E-02	1.11E-02	1.13E-02	1.14E-02	1.16E-02	1.18E-02	1.20E-02	1.21E-02	1.23E-02	1.25E-02	1.27E-02	1.28E-02	1.30E-02	1.32E-02	1.34E-02	1.35E-02	1.37E-02	1.39E-02	1.41E-02	1.42E-02	1.44E-02	1.46E-02	1.47E-02	1.49E-02	1.50E-02	1.52E-02	1.53E-02	1.55E-02	1.57E-02	1.58E-02	1.60E-02	1.61E-02	1.63E-02	1.64E-02	1.66E-02	1.68E-02	1.69E-02	1.71E-02	1.72E-02	1.74E-02	1.76E-02	1.77E-02	1.79E-02	1.81E-02	1.82E-02	1.83E-02	1.84E-02	1.85E-02	1.86E-02	1.87E-02	1.89E-02	1.90E-02	1.91E-02	1.92E-02	1.94E-02	1.95E-02	1.97E-02	1.98E-02	2.00E-02	2.02E-02	2.04E-02	2.06E-02	2.08E-02	2.09E-02	2.12E-02	2.14E-02	2.16E-02	2.17E-02	2.19E-02	2.21E-02	2.23E-02	2.25E-02	2.27E-02	2.29E-02	2.31E-02	2.33E-02	2.35E-02	2.36E-02	2.39E-02	2.41E-02	2.43E-02	2.45E-02	2.47E-02	2.49E-02	2.51E-02	2.53E-02	2.55E-02	2.57E-02	2.59E-02	2.61E-02	2.64E-02	2.66E-02	2.67E-02	2.69E-02	2.71E-02	2.73E-02	2.75E-02	2.77E-02	2.79E-02	2.81E-02	2.84E-02	2.86E-02	2.88E-02	2.90E-02	2.91E-02	2.93E-02	2.95E-02	2.97E-02	2.99E-02	3.01E-02	3.02E-02	3.04E-02	3.06E-02	3.07E-02	3.09E-02	3.11E-02	3.12E-02	3.14E-02	3.16E-02	3.17E-02	3.19E-02	3.20E-02	3.22E-02	3.23E-02	3.25E-02	3.26E-02	3.27E-02	3.28E-02	3.30E-02	3.31E-02	3.32E-02	3.33E-02	3.34E-02	3.35E-02	3.36E-02	3.37E-02	3.38E-02	3.39E-02	3.40E-02	3.41E-02	3.41E-02	3.42E-02	3.42E-02	3.43E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.44E-02	3.45E-02	3.45E-02	3.45E-02	3.45E-02	3.45E-02	3.44E-02	3.44E-02	3.43E-02	3.43E-02	3.42E-02	3.42E-02	3.41E-02	3.40E-02	3.39E-02	3.38E-02	3.37E-02	3.35E-02	3.34E-02	3.33E-02	3.32E-02	3.29E-02	3.29E-02	3.27E-02	3.25E-02	3.23E-02	3.22E-02	3.19E-02	3.17E-02	3.16E-02	3.13E-02	3.12E-02	3.09E-02	3.06E-02	3.04E-02	3.02E-02	3.00E-02	2.98E-02	2.95E-02	2.93E-02	2.89E-02	2.87E-02	2.84E-02	2.81E-02	2.78E-02	2.76E-02	2.73E-02	2.71E-02	2.68E-02	2.65E-02	2.63E-02	2.60E-02	2.57E-02	2.54E-02	2.51E-02	2.48E-02	2.46E-02	2.42E-02	2.40E-02	2.37E-02	2.35E-02	2.31E-02	2.28E-02	2.26E-02	2.24E-02	2.21E-02	2.17E-02	2.16E-02	2.12E-02	2.09E-02	2.06E-02	2.04E-02	2.00E-02	1.98E-02	1.96E-02	1.93E-02	1.91E-02	1.88E-02	1.85E-02	1.82E-02	1.80E-02	1.78E-02	1.75E-02	1.73E-02	1.71E-02	1.68E-02	1.66E-02	1.64E-02	1.63E-02	1.61E-02	1.59E-02	1.56E-02	1.55E-02	1.54E-02	1.53E-02	1.51E-02	1.50E-02	1.48E-02	1.47E-02	1.45E-02	1.45E-02	1.44E-02	1.43E-02	1.42E-02	1.41E-02	1.41E-02	1.41E-02	1.39E-02	1.39E-02	1.38E-02	1.37E-02	1.37E-02	1.36E-02	1.36E-02	1.37E-02	1.36E-02	1.35E-02	1.35E-02	1.34E-02	1.34E-02	1.33E-02	1.33E-02	1.34E-02	1.34E-02	1.34E-02	1.33E-02	1.33E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.32E-02	1.31E-02	1.32E-02	1.31E-02	1.31E-02	1.31E-02	1.31E-02];
xq = [407.469357, 410.661992, 413.854626, 417.047260, 420.239895, 423.432529, 426.625163, 429.817798, 433.010432, 436.203066, 439.395701, 442.588335, 445.780969, 448.973603, 452.166238, 455.358872, 458.551506, 461.744141, 464.936775, 468.129409, 471.322044, 474.514678, 477.707312, 480.899947, 484.092581, 487.285215, 490.477849, 493.670484, 496.863118, 500.055752, 503.248387, 506.441021, 509.633655, 512.826290, 516.018924, 519.211558, 522.404193, 525.596827, 528.789461, 531.982095, 535.174730, 538.367364, 541.559998, 544.752633, 547.945267, 551.137901, 554.330536, 557.523170, 560.715804, 563.908439, 567.101073, 570.293707, 573.486341, 576.678976, 579.871610, 583.064244, 586.256879, 589.449513, 592.642147, 595.834782, 599.027416, 602.220050, 605.412685, 608.605319, 611.797953, 614.990587, 618.183222, 621.375856, 624.568490, 627.761125, 630.953759, 634.146393, 637.339028, 640.531662, 643.724296, 646.916931, 650.109565, 653.302199, 656.494833, 659.687468, 662.880102, 666.072736, 669.265371, 672.458005, 675.650639, 678.843274, 682.035908, 685.228542, 688.421177, 691.613811, 694.806445, 697.999079, 701.191714, 704.384348, 707.576982, 710.769617, 713.962251, 717.154885, 720.347520, 723.540154, 726.732788, 729.925423, 733.118057, 736.310691, 739.503325, 742.695960, 745.888594, 749.081228, 752.273863, 755.466497, 758.659131, 761.851766, 765.044400, 768.237034, 771.429669, 774.622303, 777.814937, 781.007571, 784.200206, 787.392840, 790.585474, 793.778109, 796.970743, 800.163377, 803.356012, 806.548646, 809.741280, 812.933915, 816.126549, 819.319183, 822.511818, 825.704452, 828.897086, 832.089720, 835.282355, 838.474989, 841.667623, 844.860258, 848.052892, 851.245526, 854.438161, 857.630795, 860.823429, 864.016064, 867.208698, 870.401332, 873.593966, 876.786601, 879.979235, 883.171869, 886.364504, 889.557138, 892.749772, 895.942407, 899.135041, 902.327675, 905.520310, 908.712944, 911.905578, 915.098212, 918.290847, 921.483481, 924.676115, 927.868750, 931.061384, 934.254018, 937.446653, 940.639287, 943.831921, 947.024556, 950.217190, 953.409824, 956.602458, 959.795093, 962.987727, 966.180361, 969.372996, 972.565630, 975.758264, 978.950899, 982.143533, 985.336167, 988.528802, 991.721436, 994.914070, 998.106704];

interpolated_radiances = interp1(x,v,xq)';


[mean_max, mean_max_wavelength1] = max(mean_rad(:));
[int_max, int_wavelength] = max(interpolated_radiances(:));

diff = abs(mean_rad-interpolated_radiances);

mean_value = mean(diff(1:117));

stand_div = std(diff(1:117));

plot(1:186, interpolated_radiances, 'g');
hold on;
plot(1:186, mean_rad, 'r');
