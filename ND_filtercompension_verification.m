%In this code, we are verifying that the withND and without ND are
%measured accurately. We did this by measuring the transmittance of ND
% filter and then multiply it by the without ND measurement.
%The calculated radiance is than compared with the radiances measured by 
% the camera with ND filter  

close all;

load('data_binned_2x_2nd_try.mat');

with_ND = squeeze(radiances(1, :, :, :));
without_ND = squeeze(radiances(2, :, :, :));

trans_ND_filter = [-0.031,-0.006,-0.018,-0.006,-0.008,-0.002,-0.003,0,0.002,-0.005,0.003,0,-0.003,-0.002,0,0,0,-0.003,0,0.002,0,0,0.002,0,-0.003,0,0,0.002,0,-0.003,0,0,0,0,-0.002,0,-0.002,0,0,0,0,-0.002,0,0.002,0,0,0,0,-0.002,0,0,0,0,0,-0.002,-0.002,0.002,0,-0.002,0,-0.002,0,-0.002,0,0,0,0,0,0,-0.005,0,-0.003,0,-0.003,-0.002,0.003,0,-0.003,0,-0.002,-0.005,0,-0.003,-0.002,-0.002,0,-0.002,-0.002,0,-0.002,-0.011,-0.003,-0.003,-0.002,0.003,0.002,-0.003,-0.003,-0.003,0.003,-0.003,-0.005,-0.002,0.003,0.002,-0.005,-0.011,-0.005,-0.005,0.002,0.005,-0.005,-0.002,0.006,0,-0.003,-0.003,-0.003,0.002,0.003,0.009,0.002,0,0.003,0.008,0.011,0.014,0.026,0.021,0.015,0.015,0.014,0.029,0.017,0.027,0.026,0.04,0.018,0.021,0.024,0.034,0.041,0.046,0.055,0.058,0.067,0.09,0.102,0.107,0.107,0.148,0.131,0.186,0.24,0.281,0.362,0.426,0.552,0.642,0.821,1.001,1.19,1.463,1.767,2.092,2.521,2.975,3.5,4.063,4.688,5.392,6.096,6.871,7.674,8.513,9.331,10.17,11.009,11.826,12.607,13.365,14.088,14.764,15.396,15.994,16.563,17.041,17.484,17.848,18.155,18.419,18.626,18.777,18.89,18.945,18.97,18.929,18.881,18.782,18.66,18.495,18.309,18.103,17.879,17.628,17.375,17.114,16.855,16.585,16.331,16.042,15.767,15.482,15.205,14.931,14.664,14.404,14.13,13.869,13.631,13.393,13.168,12.952,12.741,12.527,12.341,12.149,11.971,11.813,11.659,11.504,11.365,11.238,11.116,10.997,10.889,10.786,10.695,10.611,10.539,10.469,10.406,10.364,10.315,10.283,10.255,10.237,10.223,10.228,10.233,10.248,10.272,10.304,10.344,10.388,10.446,10.5,10.568,10.631,10.707,10.793,10.881,10.973,11.075,11.172,11.276,11.388,11.508,11.623,11.745,11.862,11.983,12.109,12.23,12.357,12.483,12.614,12.735,12.854,12.981,13.106,13.226,13.347,13.469,13.593,13.704,13.82,13.928,14.03,14.136,14.232,14.325,14.407,14.487,14.56,14.626,14.688,14.745,14.796,14.838,14.874,14.906,14.932,14.954,14.972,14.981,14.984,14.986,14.978,14.967,14.952,14.932,14.909,14.88,14.851,14.816,14.78,14.738,14.696,14.653,14.607,14.561,14.516,14.468,14.415,14.366,14.317,14.27,14.217,14.165,14.114,14.063,14.014,13.963,13.918,13.869,13.823,13.779,13.736,13.692,13.647,13.603,13.554,13.507,13.457,13.405,13.368,13.333,13.274,13.216,13.159,13.098,13.037,12.976,12.917,12.862,12.81,12.752,12.695,12.643,12.59,12.537,12.488,12.437,12.387,12.34,12.291,12.247,12.204,12.164,12.126,12.09,12.056,12.024,11.993,11.967,11.943,11.916,11.887,11.859,11.83,11.795,11.752,11.707,11.656,11.601,11.539,11.467,11.394,11.313,11.232,11.153,11.07,10.988,10.912,10.837,10.759,10.687,10.62,10.558,10.503,10.452,10.408,10.374,10.344,10.323,10.31,10.309,10.32,10.342,10.374,10.425,10.489,10.565,10.657,10.762,10.878,11.005,11.145,11.293,11.452,11.623,11.79,11.96,12.131,12.306,12.477,12.651,12.816,12.979,13.136,13.293,13.434,13.562,13.687,13.811,13.921,14.024,14.124,14.218,14.319,14.417,14.52,14.63,14.748,14.879,15.016,15.164,15.32,15.48,15.657,15.837,16.037,16.26,16.504,16.765,17.052,17.363,17.703,18.094,18.541,19.035,19.595,20.213,20.882,21.619,22.415,23.256,24.197,25.211,26.265,27.37,28.534,29.712,30.934,32.225,33.519,34.851,36.264,37.666,39.073,40.419,41.8,43.166,44.548,45.9,47.22,48.54,49.837,51.12,52.377,53.622,54.878,56.126,57.379,58.614,59.805,60.934,62.041,63.141,64.273,65.39,66.472,67.528,68.518,69.479,70.444,71.365,72.273,73.169,73.996,74.789,75.562,76.283,76.979,77.678,78.333,78.954,79.536,80.098,80.615,81.149,81.654,82.127,82.6,83.061,83.492,83.91,84.291,84.669,85.03,85.385,85.704,86.023,86.327,86.613,86.877,87.129,87.364,87.604,87.814,88.039,88.234,88.423,88.596,88.757,88.914,89.066,89.209,89.352,89.484,89.6,89.713,89.832,89.943,90.038,90.132,90.225,90.311,90.393,90.472,90.54,90.608,90.671,90.732,90.791,90.852,90.9,90.956,91.002,91.048,91.093,91.135,91.176,91.214,91.255,91.287,91.328,91.348,91.374,91.412,91.443,91.463,91.49,91.51,91.531,91.559,91.583,91.605,91.628,91.637,91.65,91.669,91.689,91.707,91.719,91.731,91.737,91.756,91.766,91.777,91.785,91.8,91.8,91.809,91.821,91.835,91.843,91.855,91.861,91.864,91.87,91.882,91.895,91.899,91.895,91.908,91.911,91.913,91.922,91.93,91.936,91.948,91.948,91.956,91.957,91.965,91.963,91.969,91.972,91.991,91.997,91.992,91.997,92.006,92.017,92.018,92.017,92.023,92.033,92.023,92.035,92.039,92.046,92.047,92.052,92.049,92.056,92.061,92.075,92.073,92.073,92.078,92.073,92.081,92.078,92.078,92.079,92.09,92.09,92.091,92.088,92.09,92.081,92.081,92.084,92.079,92.09,92.081,92.078,92.072,92.072,92.065,92.047,92.035,92.024,92.029,92.014,92.003,92.001,91.989,91.974,91.96,91.939,91.931,91.92,91.911,91.902,91.89,91.876,91.85,91.827,91.817,91.788,91.766,91.743,91.724,91.692,91.661,91.629,91.6,91.574,91.556,91.531,91.507,91.486,91.47,91.441,91.432,91.412,91.411,91.405,91.402,91.412,91.406,91.417,91.415,91.425,91.429,91.441,91.454,91.473,91.487,91.501,91.51,91.507,91.522,91.551,91.585,91.595,91.609,91.632,91.655,91.676,91.684,91.685,91.713,91.73,91.739,91.754,91.774,91.782,91.809,91.838,91.83,91.856,91.875,91.89,91.927,91.933,91.93,91.977,91.983,91.992,92.021,92.014,92.041,92.056,92.07,92.081,92.072,92.104,92.108,92.108,92.105,92.114,92.116,92.108,92.117,92.108,92.091,92.088,92.075,92.076,92.064,92.058,92.068,92.067,92.061,92.065,92.05,92.046,92.026,92.029,92.017,92.012,92.003,91.995,91.985,91.971,91.963,91.962,91.957,91.939,91.934,91.93,91.914,91.902,91.899,91.899,91.893,91.876,91.861,91.856,91.847,91.826,91.818,91.809,91.78,91.763,91.762,91.76,91.753,91.733,91.711,91.689,91.698,91.713,91.71,91.687,91.666,91.66,91.667,91.672,91.681,91.685,91.676,91.675,91.667,91.667,91.682,91.672,91.655,91.638,91.631,91.628,91.624,91.634,91.634,91.629,91.628,91.644,91.65,91.65,91.653,91.65,91.656,91.67,91.664,91.672,91.696,91.713,91.721,91.743,91.751,91.765,91.776,91.797,91.814,91.817,91.824,91.838,91.84,91.849,91.861,91.866,91.888,91.888,91.896,91.907,91.927,91.948,91.951,91.951,91.948,91.945,91.978,92,92.015,92.014,92.001,92.024,92.039,92.061,92.043,92.047,92.075,92.093,92.085,92.055,92.082,92.102,92.088,92.078,92.122,92.096,92.059,92.064,92.117,92.082,92.053,92.082,92.068,92.018,92.065,92.044,92.001,92.027,91.991,92.023,92.021];

x = 190:1100;
xq = [407.469357, 410.661992, 413.854626, 417.047260, 420.239895, 423.432529, 426.625163, 429.817798, 433.010432, 436.203066, 439.395701, 442.588335, 445.780969, 448.973603, 452.166238, 455.358872, 458.551506, 461.744141, 464.936775, 468.129409, 471.322044, 474.514678, 477.707312, 480.899947, 484.092581, 487.285215, 490.477849, 493.670484, 496.863118, 500.055752, 503.248387, 506.441021, 509.633655, 512.826290, 516.018924, 519.211558, 522.404193, 525.596827, 528.789461, 531.982095, 535.174730, 538.367364, 541.559998, 544.752633, 547.945267, 551.137901, 554.330536, 557.523170, 560.715804, 563.908439, 567.101073, 570.293707, 573.486341, 576.678976, 579.871610, 583.064244, 586.256879, 589.449513, 592.642147, 595.834782, 599.027416, 602.220050, 605.412685, 608.605319, 611.797953, 614.990587, 618.183222, 621.375856, 624.568490, 627.761125, 630.953759, 634.146393, 637.339028, 640.531662, 643.724296, 646.916931, 650.109565, 653.302199, 656.494833, 659.687468, 662.880102, 666.072736, 669.265371, 672.458005, 675.650639, 678.843274, 682.035908, 685.228542, 688.421177, 691.613811, 694.806445, 697.999079, 701.191714, 704.384348, 707.576982, 710.769617, 713.962251, 717.154885, 720.347520, 723.540154, 726.732788, 729.925423, 733.118057, 736.310691, 739.503325, 742.695960, 745.888594, 749.081228, 752.273863, 755.466497, 758.659131, 761.851766, 765.044400, 768.237034, 771.429669, 774.622303, 777.814937, 781.007571, 784.200206, 787.392840, 790.585474, 793.778109, 796.970743, 800.163377, 803.356012, 806.548646, 809.741280, 812.933915, 816.126549, 819.319183, 822.511818, 825.704452, 828.897086, 832.089720, 835.282355, 838.474989, 841.667623, 844.860258, 848.052892, 851.245526, 854.438161, 857.630795, 860.823429, 864.016064, 867.208698, 870.401332, 873.593966, 876.786601, 879.979235, 883.171869, 886.364504, 889.557138, 892.749772, 895.942407, 899.135041, 902.327675, 905.520310, 908.712944, 911.905578, 915.098212, 918.290847, 921.483481, 924.676115, 927.868750, 931.061384, 934.254018, 937.446653, 940.639287, 943.831921, 947.024556, 950.217190, 953.409824, 956.602458, 959.795093, 962.987727, 966.180361, 969.372996, 972.565630, 975.758264, 978.950899, 982.143533, 985.336167, 988.528802, 991.721436, 994.914070, 998.106704];

interpolated_trans = interp1(x,trans_ND_filter/100, xq)';

%we change the dimension arrangement such that 186 is in first of 3D without_ND 
permuted_without_ND = permute(without_ND,[3,1,2]);
%then this permuted 3D without_ND is converted to 2D 
reshape_per = reshape(permuted_without_ND, 186, 731*900);

%multiplied with tranmittance values
applied_mask = interpolated_trans.*reshape_per;

%Reshape it back to the 3D such that still 186 wavelengths is in frist.
mask = reshape(applied_mask, 186, 731, 900);

%Now we shifted the wavelengths to the last dimension as originally it was.
cal_tran_rad = permute(mask, [2, 3, 1]);


with_ND_mean = mean(with_ND(:))
%red calculated
cal_tran_rad_mean = mean(cal_tran_rad(:))
plot(xq, squeeze(mean(mean(cal_tran_rad, 1, 'omitnan'), 'omitnan')),'r');
hold on;
%green ground truth
plot(xq, squeeze(mean(mean(with_ND, 1, 'omitnan'), 'omitnan')),'g');
legend('cal tran rad','with ND')
hold off;